var username=document.getElementById("username").innerHTML;forest.styles={};forest.styles.massif_style=olext.utils.makeStyle({fill_color:"rgba(0, 0, 0, 0)",stroke_color:"#FCFFD0",stroke_width:2});forest.styles.forest_style=olext.utils.makeStyle({fill_color:"rgba(146, 255, 92, 0.1)",stroke_color:"#133B10",stroke_width:1});forest.styles.forest30k_style=olext.utils.makeStyle({fill_color:"rgba(217, 92, 255, 0.1)",stroke_color:"#133B10",stroke_width:1});
forest.styles.selected_point_style=olext.utils.makeStyle({image:olext.utils.makeCircle({radius:5,fill_color:"rgb(51, 133, 214)",stroke_color:"rgb(21, 103, 184)"})});forest.styles.point_style=olext.utils.makeStyle({image:olext.utils.makeCircle({radius:5,fill_color:olext.utils.hexToRGBA("#FF8000",.8),stroke_color:olext.utils.hexToRGBA("#8A0808",.8)})});
forest.styles.point_alt_style=olext.utils.makeStyle({image:olext.utils.makeCircle({radius:5,fill_color:olext.utils.hexToRGBA("#FF5CAD",.8),stroke_color:olext.utils.hexToRGBA("#7D194B",.8)})});forest.styles.problem_style=function(a,b){return a.get("creator_username")==username?[forest.styles.point_style]:[forest.styles.point_alt_style]};forest.styles.overlay_style=olext.utils.makeStyle({image:olext.utils.makeCircle({radius:6,fill_color:olext.utils.hexToRGBA("#FF3300",.8),stroke_color:"#FF3300"})});
forest.problems={};forest.problems.problem_source=null;forest.problems.problem_select=null;forest.problems.popup=new olext.overlay.Popup({positioning:"bottom-center",autoPan:!0,autoPanAnimation:{duration:250},hide_callback:function(){forest.problems.setCurrentProblem(null);forest.problems.problem_select.getFeatures().clear()}});forest.problems.setCurrentProblem=function(a){forest.problems.showProblemPopup(a)};
forest.problems.showProblemPopup=function(a){if(a){var b="<b>"+a.get("creator_name")+"</b>",c=a.getGeometry().getCoordinates(),d=a.get("problem"),g="",h=a.get("comments");d&&(g="<em>"+d+" </em>");h&&(g=g+": "+h);a.get("creator_username")==username&&(g+='\n<button id="delete_pb_button">Supprimer</button>');forest.problems.popup.show(c,b,g);b=document.getElementById("delete_pb_button");null!=b&&b.addEventListener("click",function(){forest.problems.deleteProblem(a)})}else forest.problems.popup.hide(function(){})};
forest.problems.deleteProblem=function(a){var b=$.cookie("csrftoken");$.ajaxSetup({beforeSend:function(a,d){a.setRequestHeader("X-CSRFToken",b)}});$.ajax({url:"delete_problem",type:"POST",data:{problem_id:a.get("id")},success:function(c){forest.problems.problem_source.removeFeature(a);forest.problems.setCurrentProblem(null);forest.problems.problem_select.getFeatures().clear()},error:function(a){msg=["Erreur: Impossible de supprimer le probl\u00e8me.\n","Veuillez contacter l'administrateur du site si ",
"l'erreur persiste."];alert(msg.join(""))}})};forest.map={};forest.sources={};forest.layers={};proj4.defs("EPSG:32758","+proj=utm +zone=58 +south +datum=WGS84 +units=m +no_defs");var wms_url="http://carto.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer",target="map",view=new ol.View({projection:"EPSG:32758",center:new ol.proj.transform([165.875,-21.145],"EPSG:4326","EPSG:32758"),zoom:7.5});
forest.map=new ol.Map({target:target,layers:[new ol.layer.Tile({source:new ol.source.TileWMS({url:wms_url,params:{LAYERS:"0",FORMAT:"image/png",CRS:"EPSG:32758"},serverType:"mapserver"})})],view:view,controls:[new ol.control.Zoom,new olext.control.CurrentScale,new olext.control.SetScale(3E3)]});forest.sources.massif=null;forest.sources.problem=null;forest.layers.massif=null;forest.layers.forest3k=null;forest.layers.forest30k=null;forest.layers.problem=null;
forest.layers.initMassifLayer=function(a){forest.layers.massif=olext.utils.makeGeoJSONLayer(a,{style:forest.styles.massif_style,image_vector:!0});forest.map.addLayer(forest.layers.massif);forest.sources.massif=forest.layers.massif.getSource().getSource()};
forest.layers.initForest3kLayer=function(){forest.layers.forest3k=new ol.layer.Tile({source:new ol.source.TileWMS({url:geoserver_base_url+"niamoto/wms?service=WMS&version=1.1.0&request=GetMap&layers=niamoto:forest_digitizing_forestfragment3k&srs=EPSG:32758&cql_filter=massif_id='"+massif_id+"'"})});forest.map.addLayer(forest.layers.forest3k)};
forest.layers.initForest30kLayer=function(){forest.layers.forest30k=new ol.layer.Tile({source:new ol.source.TileWMS({url:geoserver_base_url+"niamoto/wms?service=WMS&version=1.1.0&request=GetMap&layers=niamoto:forest_digitizing_forestfragment30k&srs=EPSG:32758&cql_filter=massif_id='"+massif_id+"'"})});forest.map.addLayer(forest.layers.forest30k)};var selected_problem=null;
forest.layers.initProblemLayer=function(a){forest.layers.problem=olext.utils.makeGeoJSONLayer(a,{style:forest.styles.problem_style});forest.map.addLayer(forest.layers.problem);forest.sources.problem=forest.layers.problem.getSource();forest.problems.problem_source=forest.sources.problem;var b=new ol.interaction.Select({condition:ol.events.condition.click,filter:function(a){return a.getId()},layers:[forest.layers.problem],style:forest.styles.selected_point_style});b.on("select",function(a){a=b.getFeatures();
0<a.getLength()?(a=a.item(0),forest.problems.setCurrentProblem(a)):forest.problems.setCurrentProblem(null)});forest.problems.problem_select=b;forest.map.addInteraction(b);a=new ol.interaction.Select({condition:function(a){return"pointermove"!=a.type||a.dragging?!1:!0},layers:[forest.layers.problem],style:forest.styles.overlay_style});forest.map.addInteraction(a);a=forest.sources.massif.getFeatures()[0].get("key_name");forest.map.addControl(new forest.map.AddProblem({layer:forest.layers.problem,map:forest.map,
massif_key_name:a,problem_types:"Fronti\u00e8re;Limite de la for\u00eat;Visibilit\u00e9;A inclure;A exclure;Autre".split(";")}))};function getComboBox(a,b){var c=$('<select class="pb_type_select"></select>').attr("id",a);$.each(b,function(a,b){c.append("<option>"+b+"</option>")});return c}
forest.map.AddProblem=function(a){function b(a){e&&h.removeFeature(e);l.setPosition(void 0);m=!1}a=a||{};var c=this,d=a.problem_types,g=a.massif_key_name,h=a.layer.getSource(),k=a.map,n,e,m,p=document.createElement("button");p.innerHTML="Probl\u00e8me";var f=$("<div></div>");$("#map").append(f);f.addClass("popup-form");var u=getComboBox("type_combo",d),q=$('<textarea class="add_pb_textarea"></textarea>'),d=$("<button></button>"),r=$("<button></button>");d.html("Ok");r.html("Annuler");f.append(u);
f.append(q);f.append($("<br>"));f.append(d);f.append(r);r.on("click",b);d.on("click",function(a){var c=$.cookie("csrftoken");$.ajaxSetup({beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",c)}});$.ajax({url:"add_problem",type:"POST",data:{massif_key_name:g,x:n[0],y:n[1],problem:u.val(),comment:q.val()},success:function(a){data=JSON.parse(a);e.set("id",data.id);e.setId(data.id);e.set("creator_name",data.creator_full_name);e.set("creator_username",data.creator_username);e.set("comments",data.comments);
e.set("problem",data.problem);l.setPosition(void 0);m=!1},error:function(a){msg=["Erreur: Impossible d'ajouter le probl\u00e8me.\n","Veuillez contacter l'administrateur du site si ","l'erreur persiste."];alert(msg.join(""));b()}})});var l=new ol.Overlay({element:f,positioning:"bottom-center"});k.addOverlay(l);var t=new ol.interaction.Draw({source:h,type:"Point",condition:function(a){return ol.events.condition.noModifierKeys(a)&&0==a.originalEvent.button}});t.on("drawend",function(a){e=a.feature});
p.addEventListener("click",function(){if(!m){m=!0;var a=c.getMap();a.addInteraction(t);a.once("click",function(b){n=b.coordinate;q.val("");l.setPosition(n);a.removeInteraction(t)})}},!1);k=document.createElement("div");k.appendChild(p);k.className="add-comment ol-unselectable ol-control";ol.control.Control.call(this,{element:k,target:a.target})};ol.inherits(forest.map.AddProblem,ol.control.Control);map=forest.map;view=map.getView();map.addOverlay(forest.problems.popup);
function fitMassif(){view.fitExtent(forest.sources.massif.getExtent(),map.getSize())}function sizeContent(){var a=.85*$("#content").height();$(".column").css("height",a+"px");map.updateSize()}
$(document).ready(function(){var a=geoserver_base_url+"niamoto/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=niamoto:forest_digitizing_digitizingproblem_view &outputFormat=application%2Fjson&srsname=EPSG:32758&&cql_filter=massif_id='"+massif_id+"'";$.ajax({url:geoserver_base_url+"niamoto/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=niamoto:niamoto_data_massif&outputFormat=application%2Fjson&srsname=EPSG:32758&&cql_filter=key_name='"+massif_key_name+"'",dataType:"json",jsonp:!1,
success:function(b){forest.layers.initMassifLayer(b);forest.layers.initForest3kLayer();forest.layers.initForest30kLayer();$.ajax({url:a,dataType:"json",jsonp:!1,success:function(a){forest.layers.initProblemLayer(a);a=new olext.control.LayersVisibility({layers:[forest.layers.problem,forest.layers.forest3k,forest.layers.forest30k,forest.layers.massif],labels:["Probl\u00e8mes:","For\u00eat (3k):","For\u00eat (30k):","Massif:"],initial_states:[!0,!0,!1,!0]});map.addControl(a)}});fitMassif()}});$(window).resize(sizeContent);
sizeContent()});
